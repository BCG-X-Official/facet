
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Standard Scikit-learn Classification Summary with FACET &#8212; facet  documentation</title>
    
  <link rel="stylesheet" href="../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/gamma.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/js/gamma.js"></script>
    <script src="../_static/js/versions.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Development Guidelines" href="../contribution_guide.html" />
    <link rel="prev" title="Bootstrap simulation with FACET" href="Model_simulation_deep_dive.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../index.html">
    
      <img src="../_static/Gamma_Facet_Logo_RGB_LB.svg" class="logo" alt="logo" />
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../getting_started/getting_started.html">Getting started</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../apidoc/facet.html">API reference</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="../tutorials.html">Tutorials</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../contribution_guide.html">Development Guidelines</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../faqs.html">FAQ</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../about_us.html">About us</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../release_notes.html">Release Notes</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
        
        
          
            
                <li class="">
                    <a href="Water_Drilling_Incident_Classification_with_Facet.html">Introduction to FACET</a>
                </li>
            
          
            
                <li class="">
                    <a href="Classification_with_Facet.html">Classification with FACET: Prediabetes Study</a>
                </li>
            
          
            
                <li class="">
                    <a href="Model_simulation_deep_dive.html">Bootstrap simulation with FACET</a>
                </li>
            
          
            
                <li class="active">
                    <a href="">Standard Scikit-learn Classification Summary with FACET</a>
                </li>
            
          
        
        
        
        
        
        
        
        
        
        
      </ul>
  
  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#" class="nav-link">Standard Scikit-learn Classification Summary with FACET</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#Quick-data-preparation" class="nav-link">Quick data preparation</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#Preprocessing-and-feature-selection" class="nav-link">Preprocessing and feature selection</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#Learner-selection-with-FACET" class="nav-link">Learner selection with FACET</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#Using-the-final-fitted-model" class="nav-link">Using the final fitted model</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#Classification-Report" class="nav-link">Classification Report</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#Confusion-Matrix" class="nav-link">Confusion Matrix</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#Precision-recall-curve" class="nav-link">Precision-recall curve</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#Using-the-crossfit-for-the-best-model" class="nav-link">Using the crossfit for the best model</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#Panel-of-metrics-with-error-from-cross-validation" class="nav-link">Panel of metrics with error from cross-validation</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#ROC-Curve-with-error-based-on-cross-validation" class="nav-link">ROC Curve with error based on cross-validation</a>
        </li>
    
            </ul>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<p><img alt="21cd4a1f531d42f0b2533aff037e2558" class="no-scaled-link" src="../_images/Gamma_Facet_Logo_RGB_LB.svg" width="500" /></p>
<div class="section" id="Standard-Scikit-learn-Classification-Summary-with-FACET">
<h1>Standard Scikit-learn Classification Summary with FACET<a class="headerlink" href="#Standard-Scikit-learn-Classification-Summary-with-FACET" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<p>FACET is composed of the following key components:</p>
<ul>
<li><p><strong>Model Inspection</strong></p>
<p>FACET introduces a new algorithm to quantify dependencies and interactions between features in ML models. This new tool for human-explainable AI adds a new, global perspective to the observation-level explanations provided by the popular <a class="reference external" href="https://shap.readthedocs.io/en/latest/">SHAP</a> approach. To learn more about FACET’s model inspection capabilities, see the getting started example below.</p>
</li>
<li><p><strong>Model Simulation</strong></p>
<p>FACET’s model simulation algorithms use ML models for <em>virtual experiments</em> to help identify scenarios that optimise predicted outcomes. To quantify the uncertainty in simulations, FACET utilises a range of bootstrapping algorithms including stationary and stratified bootstraps. For an example of FACET’s bootstrap simulations, see the getting started example below.</p>
</li>
<li><p><strong>Enhanced Machine Learning Workflow</strong></p>
<p>FACET offers an efficient and transparent machine learning workflow, enhancing <a class="reference external" href="https://scikit-learn.org/stable/index.html">scikit-learn</a>’s tried and tested pipelining paradigm with new capabilities for model selection, inspection, and simulation. FACET also introduces <a class="reference external" href="https://github.com/BCG-Gamma/sklearndf">sklearndf</a>, an augmented version of <em>scikit-learn</em> with enhanced support for <em>pandas</em> dataframes that ensures end-to-end traceability of features.</p>
</li>
</ul>
<hr class="docutils" />
<p><strong>Context</strong></p>
<p>In this tutorial notebook we will first build a classifier for predicting customer churn using a well known datasets from <a class="reference external" href="https://www.kaggle.com/blastchar/telco-customer-churn">Kaggle</a>. Then using the developed classifier we will demonstrate how to perform selected typical model performance summary tasks including: - Using a final fitted model on all CV-folds to obtain a confusion matrix, classification report and precision-recall curve - Using models fitted to each CV fold, create a set of
summary metrics and a ROC curve both with an assessment of error based on the cross-validation</p>
<hr class="docutils" />
<p><strong>Tutorial outline</strong></p>
<ol class="arabic simple">
<li><p><a class="reference external" href="#Required-imports">Required imports</a></p></li>
<li><p><a class="reference external" href="#Quick-data-preparation">Quick data preparation</a></p></li>
<li><p><a class="reference external" href="#Preprocessing-and-feature-selection">Preprocessing and feature selection</a></p></li>
<li><p><a class="reference external" href="#Learner-selection-with-FACET">Learner selection with FACET</a></p></li>
<li><p><a class="reference external" href="#Using-the-final-fitted-model">Using the final fitted model</a></p></li>
<li><p><a class="reference external" href="#Using-the-crossfit-for-the-best-model">Using the crossfit for the best model</a></p></li>
</ol>
<p>In order to run this notebook, we will import not only the FACET package, but also other packages useful to solve this task. Overall, we can break down the imports into three categories:</p>
<ol class="arabic simple">
<li><p>Common packages (pandas, matplotlib, sklearn, etc.)</p></li>
<li><p>Required FACET classes (i.e., selection)</p></li>
<li><p>Other BCG GAMMA packages which simplify pipelining (sklearndf, see on <a class="reference external" href="https://github.com/orgs/BCG-Gamma/sklearndf/">GitHub</a>) when using FACET</p></li>
</ol>
<p><strong>Common package imports</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">interp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span>
    <span class="n">confusion_matrix</span><span class="p">,</span>
    <span class="n">roc_curve</span><span class="p">,</span>
    <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">auc</span><span class="p">,</span>
    <span class="n">accuracy_score</span><span class="p">,</span>
    <span class="n">f1_score</span><span class="p">,</span>
    <span class="n">precision_score</span><span class="p">,</span>
    <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">precision_recall_curve</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span>
    <span class="n">PrecisionRecallDisplay</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">make_column_selector</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">RepeatedKFold</span>
</pre></div>
</div>
</div>
<p><strong>FACET imports</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">facet.data</span> <span class="kn">import</span> <span class="n">Sample</span>
<span class="kn">from</span> <span class="nn">facet.selection</span> <span class="kn">import</span> <span class="n">LearnerRanker</span><span class="p">,</span> <span class="n">LearnerGrid</span>
<span class="kn">from</span> <span class="nn">facet.crossfit</span> <span class="kn">import</span> <span class="n">LearnerCrossfit</span>
</pre></div>
</div>
</div>
<p><strong>sklearndf imports</strong></p>
<p>Instead of using the “regular” scikit-learn package, we are going to use sklearndf (see on <a class="reference external" href="https://github.com/orgs/BCG-Gamma/sklearndf/">GitHub</a>). sklearndf is an open source library designed to address a common issue with scikit-learn: the outputs of transformers are numpy arrays, even when the input is a data frame. However, to inspect a model it is essential to keep track of the feature names. sklearndf retains all the functionality available through scikit-learn plus the feature
traceability and usability associated with Pandas data frames. Additionally, the names of all your favourite scikit-learn functions are the same except for <code class="docutils literal notranslate"><span class="pre">DF</span></code> on the end. For example, the standard scikit-learn import:</p>
<p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">sklearn.pipeline</span> <span class="pre">import</span> <span class="pre">Pipeline</span></code></p>
<p>becomes:</p>
<p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">sklearndf.pipeline</span> <span class="pre">import</span> <span class="pre">PipelineDF</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sklearndf.pipeline</span> <span class="kn">import</span> <span class="n">PipelineDF</span><span class="p">,</span> <span class="n">ClassifierPipelineDF</span>
<span class="kn">from</span> <span class="nn">sklearndf.classification</span> <span class="kn">import</span> <span class="n">RandomForestClassifierDF</span>
<span class="kn">from</span> <span class="nn">sklearndf.transformation</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ColumnTransformerDF</span><span class="p">,</span>
    <span class="n">OneHotEncoderDF</span><span class="p">,</span>
    <span class="n">SimpleImputerDF</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearndf.transformation.extra</span> <span class="kn">import</span> <span class="n">BorutaDF</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Quick-data-preparation">
<h1>Quick data preparation<a class="headerlink" href="#Quick-data-preparation" title="Permalink to this headline">¶</a></h1>
<p>We start by obtaining a dataset for analysis. In this case we use the well known Telco Customer Churn dataset from <a class="reference external" href="https://www.kaggle.com/blastchar/telco-customer-churn">Kaggle</a>.</p>
<p>Briefly, the dataset contains one row for each of 7043 customers and includes information on those who left with the last month (i.e., <code class="docutils literal notranslate"><span class="pre">Churn</span></code> - our target of interest, n=1869), services signed up for, account information and demographics.</p>
<p>As this dataset has been well described and analyzed, we apply the minimum number of steps necessary to prepare the data for this tutorial. These are as follows:</p>
<ul class="simple">
<li><p>drop the <code class="docutils literal notranslate"><span class="pre">customerID</span></code> column</p></li>
<li><p>convert <code class="docutils literal notranslate"><span class="pre">TotalCharges</span></code> to numeric type</p></li>
<li><p>convert <code class="docutils literal notranslate"><span class="pre">SeniorCitizen</span></code> to string type</p></li>
<li><p>relabel and convert <code class="docutils literal notranslate"><span class="pre">Churn</span></code> to a 0/1 target</p></li>
</ul>
<p>Finally we place the dataframe in a FACET <code class="docutils literal notranslate"><span class="pre">Sample</span></code> object for easier data management. This allows us to:</p>
<ul class="simple">
<li><p>Quickly access the target vs. features</p></li>
<li><p>Pass our data into sklearndf pipelines</p></li>
<li><p>Pass information to other FACET functions</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># This dataset is from Kaggle has been analyzed numerous times, and so we skip EDA</span>
<span class="c1"># read in the data</span>
<span class="n">churn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;KAGGLE-Telco-Customer-Churn.csv&#39;</span><span class="p">)</span>

<span class="c1"># drop customer ID</span>
<span class="n">churn_df</span> <span class="o">=</span> <span class="n">churn_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customerID&#39;</span><span class="p">])</span>

<span class="c1"># TotalCharges needs to be float (known to have a few missing values)</span>
<span class="n">churn_df</span><span class="o">.</span><span class="n">TotalCharges</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">churn_df</span><span class="o">.</span><span class="n">TotalCharges</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

<span class="c1"># To support preprocessing pipeline we will also convert SeniorCitizen to object type</span>
<span class="c1"># only tenure, MonthlyCharges and TotalCharges are numeric</span>
<span class="n">churn_df</span><span class="o">.</span><span class="n">SeniorCitizen</span> <span class="o">=</span> <span class="n">churn_df</span><span class="o">.</span><span class="n">SeniorCitizen</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Create a new 0/1 target where 1=churn</span>
<span class="n">churn_df</span><span class="o">.</span><span class="n">Churn</span> <span class="o">=</span> <span class="n">churn_df</span><span class="o">.</span><span class="n">Churn</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">Yes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">No</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># create sample object</span>
<span class="n">churn_sample</span> <span class="o">=</span> <span class="n">Sample</span><span class="p">(</span>
    <span class="n">observations</span><span class="o">=</span><span class="n">churn_df</span><span class="p">,</span>
    <span class="n">feature_names</span><span class="o">=</span><span class="n">churn_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="n">target_name</span><span class="o">=</span><span class="s2">&quot;Churn&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># check target name</span>
<span class="n">churn_sample</span><span class="o">.</span><span class="n">target_name</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;Churn&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># get feature names</span>
<span class="n">churn_sample</span><span class="o">.</span><span class="n">feature_names</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;gender&#39;,
 &#39;SeniorCitizen&#39;,
 &#39;Partner&#39;,
 &#39;Dependents&#39;,
 &#39;tenure&#39;,
 &#39;PhoneService&#39;,
 &#39;MultipleLines&#39;,
 &#39;InternetService&#39;,
 &#39;OnlineSecurity&#39;,
 &#39;OnlineBackup&#39;,
 &#39;DeviceProtection&#39;,
 &#39;TechSupport&#39;,
 &#39;StreamingTV&#39;,
 &#39;StreamingMovies&#39;,
 &#39;Contract&#39;,
 &#39;PaperlessBilling&#39;,
 &#39;PaymentMethod&#39;,
 &#39;MonthlyCharges&#39;,
 &#39;TotalCharges&#39;]
</pre></div></div>
</div>
</div>
<div class="section" id="Preprocessing-and-feature-selection">
<h1>Preprocessing and feature selection<a class="headerlink" href="#Preprocessing-and-feature-selection" title="Permalink to this headline">¶</a></h1>
<p>Our first step is to create a minimum preprocessing pipeline which based on our dataset needs to address the following:</p>
<ul class="simple">
<li><p>Simple imputation for missing values</p></li>
<li><p>One-hot encoding for categorical features</p></li>
</ul>
<p>We will use the sklearndf wrappers for scikit-learn functions such as <code class="docutils literal notranslate"><span class="pre">SimpleImputerDF</span></code> in place of <code class="docutils literal notranslate"><span class="pre">SimpleImputer</span></code>, <code class="docutils literal notranslate"><span class="pre">OneHotEncoderDF</span></code> in place of <code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code>, and so on.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># for categorical features we will use the mode as the imputation value and also one-hot encode</span>
<span class="n">preprocessing_categorical</span> <span class="o">=</span> <span class="n">PipelineDF</span><span class="p">(</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;imputer&quot;</span><span class="p">,</span> <span class="n">SimpleImputerDF</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;most_frequent&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;&lt;na&gt;&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;one-hot&quot;</span><span class="p">,</span> <span class="n">OneHotEncoderDF</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># for numeric features we will impute using the median</span>
<span class="n">preprocessing_numerical</span> <span class="o">=</span> <span class="n">SimpleImputerDF</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">)</span>

<span class="c1"># put the pipeline together</span>
<span class="n">preprocessing_features</span> <span class="o">=</span> <span class="n">ColumnTransformerDF</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;categorical&quot;</span><span class="p">,</span>
            <span class="n">preprocessing_categorical</span><span class="p">,</span>
            <span class="n">make_column_selector</span><span class="p">(</span><span class="n">dtype_include</span><span class="o">=</span><span class="nb">object</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;numerical&quot;</span><span class="p">,</span>
            <span class="n">preprocessing_numerical</span><span class="p">,</span>
            <span class="n">make_column_selector</span><span class="p">(</span><span class="n">dtype_include</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Next, we perform some initial feature selection using Boruta, a recent approach shown to have quite good performance. The Boruta algorithm removes features that are no more predictive than random noise. If you are interested further, please see this <a class="reference external" href="https://www.jstatsoft.org/article/view/v036i11">article</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">BorutaDF</span></code> transformer in our sklearndf package provides easy access to this powerful method. The approach relies on a tree-based learner, usually a random forest. For settings, a <code class="docutils literal notranslate"><span class="pre">max_depth</span></code> of between 3 and 7 is typically recommended, and here we rely on the default setting of 5. However, as this depends on the number of features and the complexity of interactions one could also explore the sensitivity of feature selection to this parameter. The number of trees is automatically managed
by the Boruta feature selector argument <code class="docutils literal notranslate"><span class="pre">n_estimators=&quot;auto&quot;</span></code>.</p>
<p>We also use parallelization for the random forest using <code class="docutils literal notranslate"><span class="pre">n_jobs</span></code> to accelerate the Boruta iterations.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create the pipeline for Boruta</span>
<span class="n">boruta_feature_selection</span> <span class="o">=</span> <span class="n">PipelineDF</span><span class="p">(</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;preprocessing&quot;</span><span class="p">,</span> <span class="n">preprocessing_features</span><span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;boruta&quot;</span><span class="p">,</span>
            <span class="n">BorutaDF</span><span class="p">(</span>
                <span class="n">estimator</span><span class="o">=</span><span class="n">RandomForestClassifierDF</span><span class="p">(</span>
                    <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
                <span class="p">),</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># run feature selection using Boruta and report those selected</span>
<span class="n">boruta_feature_selection</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">churn_sample</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">churn_sample</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
<span class="n">selected</span> <span class="o">=</span> <span class="n">boruta_feature_selection</span><span class="o">.</span><span class="n">feature_names_original_</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">selected</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;InternetService&#39;, &#39;OnlineSecurity&#39;, &#39;OnlineBackup&#39;,
       &#39;DeviceProtection&#39;, &#39;TechSupport&#39;, &#39;StreamingTV&#39;,
       &#39;StreamingMovies&#39;, &#39;Contract&#39;, &#39;PaperlessBilling&#39;, &#39;PaymentMethod&#39;,
       &#39;tenure&#39;, &#39;MonthlyCharges&#39;, &#39;TotalCharges&#39;], dtype=object)
</pre></div></div>
</div>
</div>
<div class="section" id="Learner-selection-with-FACET">
<h1>Learner selection with FACET<a class="headerlink" href="#Learner-selection-with-FACET" title="Permalink to this headline">¶</a></h1>
<p>FACET implements several additional useful wrappers which simplify comparing and tuning models:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LearnerGrid</span></code>: allows you to pass a learner pipeline (i.e., classifier + any preprocessing) and a set of hyperparameters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LearnerRanker</span></code>: multiple LearnerGrids can be passed into this class as a list - this allows tuning hyperparameters both across different types of learners in a single step and ranks the resulting models accordingly</p></li>
</ul>
<p>For the purpose of this tutorial we will assess a Random Forest Classifier and hyperparameter ranges will be assessed using 10 repeated 5-fold cross-validation and be scored using AUC:</p>
<p>Random forest: with hyperparameters</p>
<ul class="simple">
<li><p>max_depth: [4, 8, 16, 32]</p></li>
<li><p>n_estimators: [200, 500]</p></li>
</ul>
<p>Learner ranking uses the average performance minus two times the standard deviation, so that we consider both the average performance and variability when selecting a classifier.</p>
<p>If you want a list of available hyperparameters you can use <code class="docutils literal notranslate"><span class="pre">classifier_name().get_params().keys()</span></code> where <code class="docutils literal notranslate"><span class="pre">classifier_name</span></code> could be for example <code class="docutils literal notranslate"><span class="pre">RandomForestClassifierDF</span></code> and if you want to see the default values, just use <code class="docutils literal notranslate"><span class="pre">classifier_name().get_params()</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># reduce sample object to selected features</span>
<span class="n">churn_sample_kept_features</span> <span class="o">=</span> <span class="n">churn_sample</span><span class="o">.</span><span class="n">keep</span><span class="p">(</span><span class="n">feature_names</span><span class="o">=</span><span class="n">selected</span><span class="p">)</span>

<span class="c1"># Classifier pipeline composed of the feature preprocessing steps created earlier and random forest learner</span>
<span class="n">rforest_clf</span> <span class="o">=</span> <span class="n">ClassifierPipelineDF</span><span class="p">(</span>
    <span class="n">preprocessing</span><span class="o">=</span><span class="n">preprocessing_features</span><span class="p">,</span>
    <span class="n">classifier</span><span class="o">=</span><span class="n">RandomForestClassifierDF</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># set grid of hyper-parameters</span>
<span class="n">classifier_grid</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">LearnerGrid</span><span class="p">(</span>
        <span class="n">pipeline</span><span class="o">=</span><span class="n">rforest_clf</span><span class="p">,</span>
        <span class="n">learner_parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span> <span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">]},</span>
    <span class="p">),</span>
<span class="p">]</span>

<span class="c1"># run the learner ranker</span>
<span class="n">clf_ranker</span> <span class="o">=</span> <span class="n">LearnerRanker</span><span class="p">(</span>
    <span class="n">grids</span><span class="o">=</span><span class="n">classifier_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">RepeatedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_repeats</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">churn_sample_kept_features</span><span class="p">)</span>

<span class="c1"># look at results</span>
<span class="n">clf_ranker</span><span class="o">.</span><span class="n">summary_report</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>ranking_score</th>
      <th colspan="2" halign="left">roc_auc</th>
      <th colspan="3" halign="left">classifier</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>type</th>
      <th>n_estimators</th>
      <th>max_depth</th>
    </tr>
    <tr>
      <th>rank</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.825502</td>
      <td>0.846088</td>
      <td>0.010293</td>
      <td>RandomForestClassifierDF</td>
      <td>500</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.825480</td>
      <td>0.845925</td>
      <td>0.010223</td>
      <td>RandomForestClassifierDF</td>
      <td>200</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.821349</td>
      <td>0.842705</td>
      <td>0.010678</td>
      <td>RandomForestClassifierDF</td>
      <td>200</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.820969</td>
      <td>0.842484</td>
      <td>0.010758</td>
      <td>RandomForestClassifierDF</td>
      <td>500</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.801712</td>
      <td>0.822412</td>
      <td>0.010350</td>
      <td>RandomForestClassifierDF</td>
      <td>500</td>
      <td>16</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.800908</td>
      <td>0.821515</td>
      <td>0.010304</td>
      <td>RandomForestClassifierDF</td>
      <td>200</td>
      <td>16</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.794795</td>
      <td>0.816196</td>
      <td>0.010701</td>
      <td>RandomForestClassifierDF</td>
      <td>500</td>
      <td>32</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.794210</td>
      <td>0.815416</td>
      <td>0.010603</td>
      <td>RandomForestClassifierDF</td>
      <td>200</td>
      <td>32</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="Using-the-final-fitted-model">
<h1>Using the final fitted model<a class="headerlink" href="#Using-the-final-fitted-model" title="Permalink to this headline">¶</a></h1>
<p>As part of the <code class="docutils literal notranslate"><span class="pre">clf_ranker</span></code> we can access a final model (<code class="docutils literal notranslate"><span class="pre">best_model_</span></code>) that represents the selected best model but re-fit using all available training data. With this model we can then predict either the class or the probability (score) and generate standard scikit-learn classifier performance summaries such as a classification report, confusion matrix or precision-recall curve.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># obtain required quantities</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf_ranker</span><span class="o">.</span><span class="n">best_model_</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">churn_sample_kept_features</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
<span class="n">y_prob</span> <span class="o">=</span> <span class="n">clf_ranker</span><span class="o">.</span><span class="n">best_model_</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">churn_sample_kept_features</span><span class="o">.</span><span class="n">features</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">y_true</span> <span class="o">=</span> <span class="n">churn_sample_kept_features</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
</div>
<div class="section" id="Classification-Report">
<h2>Classification Report<a class="headerlink" href="#Classification-Report" title="Permalink to this headline">¶</a></h2>
<p>The classification report from scikit-learn is often used as a summary for classifiers, especially in the case of imbalanced datasets, as it provides precision, recall and the f1-score by class along with the support (number of observations for a class). For more information on the implementation in scikit-learn please see <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.classification_report.html#sklearn.metrics.classification_report">sklearn.metrics.classification_report</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
              precision    recall  f1-score   support

           0       0.85      0.92      0.89      5174
           1       0.72      0.57      0.63      1869

    accuracy                           0.83      7043
   macro avg       0.79      0.74      0.76      7043
weighted avg       0.82      0.83      0.82      7043

</pre></div></div>
</div>
</div>
<div class="section" id="Confusion-Matrix">
<h2>Confusion Matrix<a class="headerlink" href="#Confusion-Matrix" title="Permalink to this headline">¶</a></h2>
<p>The confusion matrix can be used to evaluate the accuracy of the fitted classifier by comparing the predicted class to the observed class. For more information on the implementation in scikit-learn please see <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.confusion_matrix.html">sklearn.metrics.confusion_matrix</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">ConfusionMatrixDisplay</span><span class="p">(</span><span class="n">cf_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;sklearn.metrics._plot.confusion_matrix.ConfusionMatrixDisplay at 0x221c43de640&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Scikit-learn_classifier_summaries_using_FACET_24_1.png" src="../_images/tutorial_Scikit-learn_classifier_summaries_using_FACET_24_1.png" />
</div>
</div>
</div>
<div class="section" id="Precision-recall-curve">
<h2>Precision-recall curve<a class="headerlink" href="#Precision-recall-curve" title="Permalink to this headline">¶</a></h2>
<p>The precision-recall curve is helpful for understanding the trade off between precision (positive predictive value) and recall (sensitivity) according to a specified threshold applied to the predicted probability (or score) for determining the predicted class for an observation. For more information on the implementation in scikit-learn please see
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.precision_recall_curve.html#sklearn.metrics.precision_recall_curve">sklearn.metrics.precision_recall_curve</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">prec</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">PrecisionRecallDisplay</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="n">prec</span><span class="p">,</span> <span class="n">recall</span><span class="o">=</span><span class="n">recall</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;sklearn.metrics._plot.precision_recall_curve.PrecisionRecallDisplay at 0x221ce1b0670&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Scikit-learn_classifier_summaries_using_FACET_26_1.png" src="../_images/tutorial_Scikit-learn_classifier_summaries_using_FACET_26_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Using-the-crossfit-for-the-best-model">
<h1>Using the crossfit for the best model<a class="headerlink" href="#Using-the-crossfit-for-the-best-model" title="Permalink to this headline">¶</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">clf_ranker</span></code> also contains a crossfit object (<code class="docutils literal notranslate"><span class="pre">best_model_crossfit_</span></code>) which allows us to access the test training splits from the cross-validation via <code class="docutils literal notranslate"><span class="pre">.splits()</span></code> and the best model fit on each splits training set via <code class="docutils literal notranslate"><span class="pre">.models()</span></code>.</p>
<p>With this information we can iterate over the cross-validation splits and generate performance metrics (or any other summary) for each trained model, providing a set of results. This is often useful when we want to get some sense of the variability in performance across the cross-validation folds. This is also exactly what the <code class="docutils literal notranslate"><span class="pre">LearnerRanker</span></code> is doing for the specified performance metric to get obtain average performance - 2 standard deviations.</p>
<p>Here we give two examples, the first is summarising the mean performance and standard deviation for a selection of common classifier performance metrics, and the second, is creating an average ROC curve with an assessment of variability across folds by plotting the RCO curve <span class="math notranslate nohighlight">\(\pm\)</span> 1 standard deviation.</p>
<div class="section" id="Panel-of-metrics-with-error-from-cross-validation">
<h2>Panel of metrics with error from cross-validation<a class="headerlink" href="#Panel-of-metrics-with-error-from-cross-validation" title="Permalink to this headline">¶</a></h2>
<p>As cross-validation is intended to inform us about average performance on a test-set, it can be helpful to collate statistics about the variability of performance as well. Below we demonstrate how to use the best model crossfit object to obtain both the mean and standard deviation for a set of common classification metrics: Accuracy, F1, Precision, Recall and AUC. This approach can of course be adapted to any metric and any summary thereof.</p>
<p>For more information about classifier metrics in scikit-learn please see <a class="reference external" href="https://scikit-learn.org/stable/modules/model_evaluation.html#classification-metrics">classification-metrics</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># use established crossfit which contains all splits and fitted models</span>
<span class="n">best_crossfit</span> <span class="o">=</span> <span class="n">clf_ranker</span><span class="o">.</span><span class="n">best_model_crossfit_</span>
<span class="k">for</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">),</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">best_crossfit</span><span class="o">.</span><span class="n">splits</span><span class="p">(),</span> <span class="n">best_crossfit</span><span class="o">.</span><span class="n">models</span><span class="p">()):</span>

    <span class="c1"># get required target outputs</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">churn_sample_kept_features</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
    <span class="n">y_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">churn_sample_kept_features</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">churn_sample_kept_features</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">])</span>

    <span class="c1"># calculate metrics</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
        <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;F1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)}))</span>

<span class="c1"># collect required summaries and plot</span>
<span class="n">metrics_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">metrics_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="n">metrics_df</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
    <span class="n">yerr</span><span class="o">=</span><span class="n">metrics_df</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
    <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
    <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span>
    <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Metric +/- SD&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Summary of model performance&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Summary of model performance&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Scikit-learn_classifier_summaries_using_FACET_29_1.png" src="../_images/tutorial_Scikit-learn_classifier_summaries_using_FACET_29_1.png" />
</div>
</div>
</div>
<div class="section" id="ROC-Curve-with-error-based-on-cross-validation">
<h2>ROC Curve with error based on cross-validation<a class="headerlink" href="#ROC-Curve-with-error-based-on-cross-validation" title="Permalink to this headline">¶</a></h2>
<p>Another common performance summary for a classifier is the ROC curve which shows the trade of between the False Positive Rate and the True Positive Rate at all classification thresholds. While we can plot one curve for the best model, using the crossfit object we can get an assessment of the standard deviation at each threshold and in turn capture some information about the variability of the ROC curve.</p>
<p>For more information about cross-validation ROC curves in scikit-learn please see the basis for this example here: <a class="reference external" href="https://scikit-learn.org/stable/auto_examples/model_selection/plot_roc_crossval.html#sphx-glr-auto-examples-model-selection-plot-roc-crossval-py">plot_roc_crossval</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># define plotting function</span>
<span class="k">def</span> <span class="nf">roc_plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">tpr_std</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">auc_std</span><span class="p">):</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Mean ROC (AUC = </span><span class="si">%0.2f</span><span class="s1"> $\pm$ </span><span class="si">%0.2f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">auc</span><span class="p">,</span> <span class="n">auc_std</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.8</span><span class="p">)</span>
    <span class="n">tpr_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">tpr</span> <span class="o">+</span> <span class="n">tpr_std</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">tpr_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">tpr</span> <span class="o">-</span> <span class="n">tpr_std</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr_lower</span><span class="p">,</span> <span class="n">tpr_upper</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\pm$ 1 SD&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ROC&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># some set-up</span>
<span class="n">tprs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">aucs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mean_fpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># use established crossfit which contains all splits and fitted models</span>
<span class="n">best_crossfit</span> <span class="o">=</span> <span class="n">clf_ranker</span><span class="o">.</span><span class="n">best_model_crossfit_</span>
<span class="k">for</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">),</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">best_crossfit</span><span class="o">.</span><span class="n">splits</span><span class="p">(),</span> <span class="n">best_crossfit</span><span class="o">.</span><span class="n">models</span><span class="p">()):</span>

    <span class="c1"># predict probability for a splits test set using the fitted model</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">churn_sample_kept_features</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">])</span>

    <span class="c1"># calculate roc curve and interpolate true positive rate</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">churn_sample_kept_features</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">test_index</span><span class="p">],</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">tprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="p">(</span><span class="n">mean_fpr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">))</span>

    <span class="c1"># calculate AUC</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">aucs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc</span><span class="p">)</span>

<span class="c1"># collect required summaries</span>
<span class="n">auc_mean</span><span class="p">,</span> <span class="n">auc_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aucs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">aucs</span><span class="p">)</span>
<span class="n">mean_tpr</span><span class="p">,</span> <span class="n">std_tpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tprs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tprs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># create plot</span>
<span class="n">roc_plot</span><span class="p">(</span><span class="n">mean_fpr</span><span class="p">,</span> <span class="n">mean_tpr</span><span class="p">,</span> <span class="n">std_tpr</span><span class="p">,</span> <span class="n">auc_mean</span><span class="p">,</span> <span class="n">auc_std</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Scikit-learn_classifier_summaries_using_FACET_31_0.png" src="../_images/tutorial_Scikit-learn_classifier_summaries_using_FACET_31_0.png" />
</div>
</div>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="Model_simulation_deep_dive.html" title="previous page">Bootstrap simulation with FACET</a>
    <a class='right-next' id="next-link" href="../contribution_guide.html" title="next page">Development Guidelines</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../_static/js/index.d3f166471bb80abb5163.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2022, Boston Consulting Group (BCG).<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>