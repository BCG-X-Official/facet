
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>facet.selection._selection &#8212; facet  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/gamma.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/gamma.js"></script>
    <script src="../../../_static/js/versions.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../../index.html">
  <img src="../../../_static/Gamma_Facet_Logo_RGB_LB.svg" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../_generated/getting_started.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../apidoc/facet.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../tutorials.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../contribution_guide.html">
  Development Guidelines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../faqs.html">
  FAQ
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../about_us.html">
  About us
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../_generated/release_notes.html">
  Release Notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for facet.selection._selection</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Core implementation of :mod:`facet.selection`</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generic</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Pattern</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.typing</span> <span class="k">as</span> <span class="nn">npt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">get_scorer</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">BaseCrossValidator</span><span class="p">,</span> <span class="n">GridSearchCV</span>

<span class="kn">from</span> <span class="nn">pytools.api</span> <span class="kn">import</span> <span class="n">AllTracker</span><span class="p">,</span> <span class="n">inheritdoc</span><span class="p">,</span> <span class="n">to_list</span>
<span class="kn">from</span> <span class="nn">pytools.fit</span> <span class="kn">import</span> <span class="n">FittableMixin</span><span class="p">,</span> <span class="n">fitted_only</span>
<span class="kn">from</span> <span class="nn">pytools.parallelization</span> <span class="kn">import</span> <span class="n">ParallelizableMixin</span>
<span class="kn">from</span> <span class="nn">sklearndf</span> <span class="kn">import</span> <span class="n">EstimatorDF</span>
<span class="kn">from</span> <span class="nn">sklearndf.pipeline</span> <span class="kn">import</span> <span class="n">LearnerPipelineDF</span>

<span class="kn">from</span> <span class="nn">facet.data</span> <span class="kn">import</span> <span class="n">Sample</span>
<span class="kn">from</span> <span class="nn">facet.selection</span> <span class="kn">import</span> <span class="n">MultiEstimatorParameterSpace</span><span class="p">,</span> <span class="n">ParameterSpace</span>
<span class="kn">from</span> <span class="nn">facet.selection.base</span> <span class="kn">import</span> <span class="n">BaseParameterSpace</span><span class="p">,</span> <span class="n">CandidateEstimatorDF</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LearnerSelector&quot;</span><span class="p">]</span>

<span class="c1">#</span>
<span class="c1"># Type constants</span>
<span class="c1">#</span>

<span class="c1"># sklearn does not publish base class BaseSearchCV, so we pull it from the MRO</span>
<span class="c1"># of GridSearchCV</span>
<span class="n">BaseSearchCV</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
    <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">cls</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;BaseSearchCV&quot;</span><span class="p">,</span> <span class="n">GridSearchCV</span><span class="o">.</span><span class="n">mro</span><span class="p">())</span>
<span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Type variables</span>
<span class="c1">#</span>

<span class="n">T_LearnerSelector</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T_LearnerSelector&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;LearnerSelector[Any, Any]&quot;</span><span class="p">)</span>
<span class="n">T_EstimatorDF</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T_EstimatorDF&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">EstimatorDF</span><span class="p">)</span>
<span class="c1"># mypy - disabling due to lack of support for dynamic types</span>
<span class="n">T_SearchCV</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T_SearchCV&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">BaseSearchCV</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

<span class="c1">#</span>
<span class="c1"># Constants</span>
<span class="c1">#</span>

<span class="n">ARG_SAMPLE_WEIGHT</span> <span class="o">=</span> <span class="s2">&quot;sample_weight&quot;</span>

<span class="c1">#</span>
<span class="c1"># Ensure all symbols introduced below are included in __all__</span>
<span class="c1">#</span>

<span class="n">__tracker</span> <span class="o">=</span> <span class="n">AllTracker</span><span class="p">(</span><span class="nb">globals</span><span class="p">())</span>


<span class="c1">#</span>
<span class="c1"># Class definitions</span>
<span class="c1">#</span>


<div class="viewcode-block" id="LearnerSelector"><a class="viewcode-back" href="../../../apidoc/facet/selection/facet.selection.LearnerSelector.html#facet.selection.LearnerSelector">[docs]</a><span class="nd">@inheritdoc</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="s2">&quot;[see superclass]&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LearnerSelector</span><span class="p">(</span>
    <span class="n">FittableMixin</span><span class="p">[</span><span class="n">Sample</span><span class="p">],</span> <span class="n">ParallelizableMixin</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">T_EstimatorDF</span><span class="p">,</span> <span class="n">T_SearchCV</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select the best model obtained by fitting an estimator using different</span>
<span class="sd">    choices of hyperparameters from one or more :class:`.ParameterSpace` objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># defined in superclass, repeated here for Sphinx</span>
    <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

    <span class="c1"># defined in superclass, repeated here for Sphinx</span>
    <span class="n">shared_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>

    <span class="c1"># defined in superclass, repeated here for Sphinx</span>
    <span class="n">pre_dispatch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>

    <span class="c1"># defined in superclass, repeated here for Sphinx</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

    <span class="c1">#: A cross-validation searcher class, or any other callable</span>
    <span class="c1">#: that instantiates a cross-validation searcher, wrapped in</span>
    <span class="c1">#: a tuple to avoid confusion with methods</span>
    <span class="n">searcher_type</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">T_SearchCV</span><span class="p">]]</span>

    <span class="c1">#: The parameter space to search.</span>
    <span class="n">parameter_space</span><span class="p">:</span> <span class="n">BaseParameterSpace</span><span class="p">[</span><span class="n">T_EstimatorDF</span><span class="p">]</span>

    <span class="c1">#: The cross-validator to be used by the searcher.</span>
    <span class="n">cv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseCrossValidator</span><span class="p">]</span>

    <span class="c1">#: The scoring function (by name, or as a callable) to be used by the searcher</span>
    <span class="c1">#: (optional; use learner&#39;s default scorer if not specified here)</span>
    <span class="n">scoring</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="n">Callable</span><span class="p">[[</span><span class="n">EstimatorDF</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span>
        <span class="kc">None</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1">#: Additional parameters to be passed on to the searcher.</span>
    <span class="n">searcher_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

    <span class="c1">#: The searcher used to fit this LearnerSelector; ``None`` if not fitted.</span>
    <span class="n">searcher_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">T_SearchCV</span><span class="p">]</span>

    <span class="c1"># regular expressions and replacement patterns for selecting and renaming</span>
    <span class="c1"># relevant columns from scikit-learn&#39;s cv_result_ table</span>
    <span class="n">_CV_RESULT_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;rank_test_(\w+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1__test__rank&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(mean|std)_test_(\w+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\2__test__\1&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;candidate_name&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;candidate&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;param_(\w+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;param__\1&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(rank|mean|std)_(\w+)_time&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;time__\2__\1&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(rank|mean|std)_(\w+)_(\w+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\3__\2__\1&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">_CV_RESULT_PATTERNS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span> <span class="n">repl</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">repl</span> <span class="ow">in</span> <span class="n">_CV_RESULT_COLUMNS</span>
    <span class="p">]</span>

    <span class="n">_CV_RESULT_CANDIDATE_PATTERN</span><span class="p">,</span> <span class="n">_CV_RESULT_CANDIDATE_REPL</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;^(?:&quot;</span>
            <span class="c1"># remove the candidate prefix from proper params</span>
            <span class="sa">r</span><span class="s2">&quot;(param_)candidate__&quot;</span>
            <span class="sa">r</span><span class="s2">&quot;|&quot;</span>
            <span class="c1"># remove the param prefix from candidate properties</span>
            <span class="sa">r</span><span class="s2">&quot;param_(candidate(?:_name)?)$&quot;</span>
            <span class="sa">r</span><span class="s2">&quot;)&quot;</span>
        <span class="p">),</span>
        <span class="sa">r</span><span class="s2">&quot;\1\2&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Default column to sort by in the summary_report() method.</span>
    <span class="c1"># This has no influence on how the best model is selected.</span>
    <span class="n">_DEFAULT_REPORT_SORT_COLUMN</span> <span class="o">=</span> <span class="s2">&quot;rank_test_score&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">searcher_type</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">T_SearchCV</span><span class="p">],</span>
        <span class="n">parameter_space</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">ParameterSpace</span><span class="p">[</span><span class="n">T_EstimatorDF</span><span class="p">],</span>
            <span class="n">MultiEstimatorParameterSpace</span><span class="p">[</span><span class="n">T_EstimatorDF</span><span class="p">],</span>
            <span class="n">Iterable</span><span class="p">[</span><span class="n">ParameterSpace</span><span class="p">[</span><span class="n">T_EstimatorDF</span><span class="p">]],</span>
        <span class="p">],</span>
        <span class="n">cv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseCrossValidator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scoring</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Callable</span><span class="p">[</span>
                <span class="p">[</span><span class="n">EstimatorDF</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span>
                <span class="nb">float</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shared_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_dispatch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">searcher_params</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param searcher_type: a cross-validation searcher class, or any other</span>
<span class="sd">            callable that instantiates a cross-validation searcher</span>
<span class="sd">        :param parameter_space: one or more parameter spaces to search; when passing</span>
<span class="sd">            multiple parameter spaces as an iterable, they are combined into a</span>
<span class="sd">            :class:`.MultiEstimatorParameterSpace`</span>
<span class="sd">        :param cv: the cross-validator to be used by the searcher</span>
<span class="sd">            (e.g., :class:`~sklearn.model_selection.RepeatedKFold`)</span>
<span class="sd">        :param scoring: a scoring function (by name, or as a callable) to be used by the</span>
<span class="sd">            searcher (optional; use learner&#39;s default scorer if not specified here).</span>
<span class="sd">            If passing a callable, ``&quot;score&quot;`` will be used as the name of the</span>
<span class="sd">            scoring function unless the callable defines a ``__name__`` attribute</span>
<span class="sd">        %%PARALLELIZABLE_PARAMS%%</span>
<span class="sd">        :param searcher_params: additional parameters to be passed on to the searcher;</span>
<span class="sd">            must not include the first two positional arguments of the searcher</span>
<span class="sd">            constructor used to pass the estimator and the search space, since these</span>
<span class="sd">            will be populated from arg ``parameter_space``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
            <span class="n">shared_memory</span><span class="o">=</span><span class="n">shared_memory</span><span class="p">,</span>
            <span class="n">pre_dispatch</span><span class="o">=</span><span class="n">pre_dispatch</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">searcher_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">searcher_type</span><span class="p">,)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter_space</span><span class="p">,</span> <span class="n">BaseParameterSpace</span><span class="p">):</span>
            <span class="n">parameter_spaces</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span>
                <span class="n">Union</span><span class="p">[</span>
                    <span class="n">ParameterSpace</span><span class="p">[</span><span class="n">T_EstimatorDF</span><span class="p">],</span>
                    <span class="n">MultiEstimatorParameterSpace</span><span class="p">[</span><span class="n">T_EstimatorDF</span><span class="p">],</span>
                <span class="p">]</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span>
                <span class="n">parameter_space</span><span class="p">,</span>
                <span class="n">element_type</span><span class="o">=</span><span class="p">(</span><span class="n">ParameterSpace</span><span class="p">,</span> <span class="n">MultiEstimatorParameterSpace</span><span class="p">),</span>
                <span class="n">arg_name</span><span class="o">=</span><span class="s2">&quot;parameter_space&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter_spaces</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">parameter_space</span> <span class="o">=</span> <span class="n">parameter_spaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parameter_space</span> <span class="o">=</span> <span class="n">MultiEstimatorParameterSpace</span><span class="p">(</span>
                    <span class="o">*</span><span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">ParameterSpace</span><span class="p">[</span><span class="n">T_EstimatorDF</span><span class="p">]],</span> <span class="n">parameter_spaces</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_space</span> <span class="o">=</span> <span class="n">parameter_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv</span> <span class="o">=</span> <span class="n">cv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scoring</span> <span class="o">=</span> <span class="n">scoring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searcher_params</span> <span class="o">=</span> <span class="n">searcher_params</span>

        <span class="c1">#</span>
        <span class="c1"># validate parameters for the searcher factory</span>
        <span class="c1">#</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">searcher_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;arg searcher_type expected to be a callable, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but is a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">searcher_type</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">searcher_factory_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">searcher_type</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># raise an error if the searcher params include the searcher&#39;s first two</span>
        <span class="c1"># positional arguments</span>
        <span class="n">reserved_params</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">searcher_factory_params</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">reserved_params_overrides</span> <span class="o">=</span> <span class="n">reserved_params</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">searcher_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">reserved_params_overrides</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;arg searcher_params must not include the first two positional &quot;</span>
                <span class="s2">&quot;arguments of arg searcher_type, but included: &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reserved_params_overrides</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># raise an error if the searcher does not support any of the given parameters</span>
        <span class="n">unsupported_params</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_searcher_parameters</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span>
            <span class="n">searcher_factory_params</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">unsupported_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;parameters not supported by arg searcher_type: &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unsupported_params</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">searcher_</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># mypy - incorrect type inference for __doc__</span>
    <span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">PARALLELIZABLE_PARAMS</span><span class="si">%%</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ParallelizableMixin</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;[see superclass]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">searcher_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="nd">@fitted_only</span>
    <span class="k">def</span> <span class="nf">best_estimator_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T_EstimatorDF</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The model which obtained the best ranking score, fitted on the entire sample.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">searcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searcher_</span>
        <span class="k">assert</span> <span class="n">searcher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Ranker is fitted&quot;</span>

        <span class="k">if</span> <span class="n">searcher</span><span class="o">.</span><span class="n">refit</span><span class="p">:</span>
            <span class="n">best_estimator</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">best_estimator_</span>
            <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_estimator</span><span class="p">,</span> <span class="n">CandidateEstimatorDF</span><span class="p">):</span>
                <span class="c1"># unpack the candidate estimator</span>
                <span class="n">best_estimator</span> <span class="o">=</span> <span class="n">best_estimator</span><span class="o">.</span><span class="n">candidate</span>
            <span class="k">return</span> <span class="n">best_estimator</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;best_estimator_ is not defined; use a CV searcher with refit=True&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="LearnerSelector.fit"><a class="viewcode-back" href="../../../apidoc/facet/selection/facet.selection.LearnerSelector.html#facet.selection.LearnerSelector.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>  <span class="c1"># type: ignore[override]</span>
        <span class="c1"># todo: remove &#39;type: ignore&#39; once mypy correctly infers return type</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">T_LearnerSelector</span><span class="p">,</span>
        <span class="n">sample</span><span class="p">:</span> <span class="n">Sample</span><span class="p">,</span>
        <span class="n">groups</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">fit_params</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T_LearnerSelector</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search this learner selector&#39;s parameter space to identify the model with the</span>
<span class="sd">        best-performing hyperparameter combination, using the given sample to fit and</span>
<span class="sd">        score the candidate estimators.</span>

<span class="sd">        :param sample: the sample used to fit and score the estimators</span>
<span class="sd">        :param groups: group labels for the samples used while splitting the dataset</span>
<span class="sd">            into train/test set; passed on to the ``fit`` method of the searcher</span>
<span class="sd">        :param fit_params: parameters to pass on to the estimator&#39;s fit method</span>
<span class="sd">        :return: ``self``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_fit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ARG_SAMPLE_WEIGHT</span> <span class="ow">in</span> <span class="n">fit_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;arg sample_weight is not supported, use &#39;weight&#39; property of arg &quot;</span>
                <span class="s2">&quot;sample instead&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">groups</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;index of arg groups is not equal to index of arg sample&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;length of arg groups is not equal to length of arg sample&quot;</span>
            <span class="p">)</span>

        <span class="n">parameter_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_space</span>
        <span class="p">(</span><span class="n">searcher_type</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searcher_type</span>
        <span class="n">searcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searcher_</span> <span class="o">=</span> <span class="n">searcher_type</span><span class="p">(</span>
            <span class="n">parameter_space</span><span class="o">.</span><span class="n">estimator</span><span class="p">,</span>
            <span class="n">parameter_space</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_searcher_parameters</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fit_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">ARG_SAMPLE_WEIGHT</span><span class="p">:</span> <span class="n">sample</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">}</span>

        <span class="n">searcher</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="LearnerSelector.summary_report"><a class="viewcode-back" href="../../../apidoc/facet/selection/facet.selection.LearnerSelector.html#facet.selection.LearnerSelector.summary_report">[docs]</a>    <span class="nd">@fitted_only</span>
    <span class="k">def</span> <span class="nf">summary_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a summary table of the scores achieved by all learners in the grid</span>
<span class="sd">        search, sorted by ranking score in descending order.</span>

<span class="sd">        :param sort_by: name of the column to sort the report by, in ascending order,</span>
<span class="sd">            if the column is present (default: ``&quot;%%SORT_COLUMN%%&quot;``)</span>

<span class="sd">        :return: the summary report of the grid search as a data frame</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">sort_by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sort_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_REPORT_SORT_COLUMN</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">searcher_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Ranker is fitted&quot;</span>

        <span class="c1"># get the raw CV results</span>
        <span class="n">cv_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searcher_</span><span class="o">.</span><span class="n">cv_results_</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter_space</span><span class="o">.</span><span class="n">estimator</span><span class="p">,</span> <span class="n">CandidateEstimatorDF</span><span class="p">):</span>
            <span class="c1"># our estimator is a candidate estimator, so we need to unpack the</span>
            <span class="c1"># candidate&#39;s parameter names</span>
            <span class="n">cv_results</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_CV_RESULT_CANDIDATE_PATTERN</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_CV_RESULT_CANDIDATE_REPL</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">):</span> <span class="n">values</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">cv_results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>

        <span class="c1"># we create a table using a subset of the cv results, to keep the report</span>
        <span class="c1"># relevant and readable</span>

        <span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">repl</span><span class="p">:</span> <span class="nb">str</span>

        <span class="k">def</span> <span class="nf">_process</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="c1"># process the name of the original cv_results_ record</span>
            <span class="c1"># to achieve a better table format</span>

            <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># we could not match the name:</span>
                <span class="c1"># return None, so we don&#39;t include it in the summary report</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">repl</span><span class="p">)</span>

        <span class="c1"># add all columns that match any of the pre-defined patterns</span>

        <span class="n">cv_results_processed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">repl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CV_RESULT_PATTERNS</span><span class="p">:</span>
            <span class="n">cv_results_processed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">name_processed</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">name_processed</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="c1"># iterate matches between pattern and name</span>
                        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_process</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">values</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">cv_results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cv_results_processed</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">name_processed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># add the sorting column as the leftmost column of the report</span>

        <span class="n">sort_column_processed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

        <span class="n">sort_column_processed</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv_results_processed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort_by</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_column_processed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sort_column_values</span> <span class="o">=</span> <span class="n">cv_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort_by</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sort_column_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sort_column_processed</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sort_column_processed</span> <span class="o">=</span> <span class="n">sort_by</span>
                <span class="n">cv_results_processed</span><span class="p">[</span><span class="n">sort_by</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="n">sort_by</span><span class="p">]</span>

        <span class="c1"># convert the results into a data frame and sort</span>

        <span class="n">report</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">name_processed</span><span class="p">:</span> <span class="n">values</span>
                <span class="k">for</span> <span class="n">name_processed</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">cv_results_processed</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># sort the report, if applicable</span>

        <span class="k">if</span> <span class="n">sort_column_processed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sort_column_processed</span><span class="p">)</span>

        <span class="c1"># split column headers containing one or more &quot;__&quot;,</span>
        <span class="c1"># resulting in a column MultiIndex</span>

        <span class="n">report</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">column</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">level</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;-&quot;</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">column</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">report</span></div>

    <span class="k">def</span> <span class="nf">_reset_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># make this object not fitted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searcher_</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_searcher_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># make a dict of all parameters to be passed to the searcher</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">cv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cv</span><span class="p">,</span>
                    <span class="n">scoring</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_scorer</span><span class="p">(),</span>
                    <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span>
                    <span class="n">shared_memory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_memory</span><span class="p">,</span>
                    <span class="n">pre_dispatch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_dispatch</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">},</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">searcher_params</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_scorer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">EstimatorDF</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="n">scoring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoring</span>

        <span class="k">if</span> <span class="n">scoring</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scoring</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">scorer</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
                <span class="p">[</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span> <span class="nb">float</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">get_scorer</span><span class="p">(</span><span class="n">scoring</span><span class="p">)</span>

        <span class="c1"># noinspection PyPep8Naming</span>
        <span class="k">def</span> <span class="nf">_scorer_fn</span><span class="p">(</span><span class="n">estimator</span><span class="p">:</span> <span class="n">EstimatorDF</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">CandidateEstimatorDF</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">estimator</span><span class="o">.</span><span class="n">candidate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;estimator candidate is set&quot;</span>
                <span class="n">estimator</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">candidate</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">LearnerPipelineDF</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">estimator</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">:</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
                <span class="n">estimator</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">final_estimator</span>

            <span class="k">return</span> <span class="n">scorer</span><span class="p">(</span><span class="n">estimator</span><span class="o">.</span><span class="n">native_estimator</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_scorer_fn</span>

    <span class="c1"># mypy - incorrect type inference for __doc__</span>
    <span class="n">summary_report</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">summary_report</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">SORT_COLUMN</span><span class="si">%%</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_DEFAULT_REPORT_SORT_COLUMN</span>
    <span class="p">)</span></div>


<span class="n">__tracker</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Boston Consulting Group (BCG).<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>