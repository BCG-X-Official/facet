
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bootstrap simulation with FACET &#8212; facet  documentation</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/gamma.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/js/gamma.js"></script>
    <script src="../_static/js/versions.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Intuition on synergy &amp; redundancy" href="Synergy_Redundancy_Tutorial_with_Facet.html" />
    <link rel="prev" title="Classification with FACET: Prediabetes Study" href="Classification_with_Facet.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../index.html">
    
      <img src="../_static/Gamma_Facet_Logo_RGB_LB.svg" class="logo" alt="logo" />
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../getting_started.html">Getting started</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../apidoc/facet.html">API reference</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="../tutorials.html">Tutorials</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../contribution_guide.html">Development Guidelines</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../faqs.html">FAQ</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../about_us.html">About us</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
        
        
          
            
                <li class="">
                    <a href="Water_Drilling_Incident_Classification_with_Facet.html">Introduction to FACET</a>
                </li>
            
          
            
                <li class="">
                    <a href="Predictive_Maintenance_Regression_with_Facet.html">Regression with FACET: Predictive Maintenance</a>
                </li>
            
          
            
                <li class="">
                    <a href="Classification_with_Facet.html">Classification with FACET: Prediabetes Study</a>
                </li>
            
          
            
                <li class="active">
                    <a href="">Bootstrap simulation with FACET</a>
                </li>
            
          
            
                <li class="">
                    <a href="Synergy_Redundancy_Tutorial_with_Facet.html">Intuition on synergy & redundancy</a>
                </li>
            
          
        
        
        
        
        
        
        
        
      </ul>
  
  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#" class="nav-link">Bootstrap simulation with FACET</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#Required-imports" class="nav-link">Required imports</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#Data" class="nav-link">Data</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#Bootstrap-simulation-overview" class="nav-link">Bootstrap simulation overview</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#Partitioning" class="nav-link">Partitioning</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#Creating-multiple-train-and-test-splits-with-bootstrap-resampling" class="nav-link">Creating multiple train and test splits with bootstrap resampling</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#Model-fitting-using-resampled-training-sets" class="nav-link">Model fitting using resampled training sets</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#Simulating-actuals" class="nav-link">Simulating actuals</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#Simulating-response" class="nav-link">Simulating response</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#Summary" class="nav-link">Summary</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#What-can-you-do-next?" class="nav-link">What can you do next?</a>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<p><img alt="4cfedeff4fc442ee939803d63ff6711a" class="no-scaled-link" src="../_images/Gamma_Facet_Logo_RGB_LB1.svg" width="500" /></p>
<div class="section" id="Bootstrap-simulation-with-FACET">
<h1>Bootstrap simulation with FACET<a class="headerlink" href="#Bootstrap-simulation-with-FACET" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<p>FACET is composed of the following key components:</p>
<ul>
<li><p><strong>Model Inspection</strong></p>
<p>FACET introduces a new algorithm to quantify dependencies and interactions between features in ML models. This new tool for human-explainable AI adds a new, global perspective to the observation-level explanations provided by the popular <a class="reference external" href="https://shap.readthedocs.io/en/latest/">SHAP</a> approach. To learn more about FACET’s model inspection capabilities, see the getting started example below.</p>
</li>
<li><p><strong>Model Simulation</strong></p>
<p>FACET’s model simulation algorithms use ML models for <em>virtual experiments</em> to help identify scenarios that optimise predicted outcomes. To quantify the uncertainty in simulations, FACET utilises a range of bootstrapping algorithms including stationary and stratified bootstraps. For an example of FACET’s bootstrap simulations, see the getting started example below.</p>
</li>
<li><p><strong>Enhanced Machine Learning Workflow</strong></p>
<p>FACET offers an efficient and transparent machine learning workflow, enhancing <a class="reference external" href="https://scikit-learn.org/stable/index.html">scikit-learn</a>’s tried and tested pipelining paradigm with new capabilities for model selection, inspection, and simulation. FACET also introduces <a class="reference external" href="https://github.com/BCG-Gamma/sklearndf">sklearndf</a>, an augmented version of <em>scikit-learn</em> with enhanced support for <em>pandas</em> dataframes that ensures end-to-end traceability of features.</p>
</li>
</ul>
<hr class="docutils" />
<p><strong>Context</strong></p>
<p>This tutorial aims to provide a step by step explanation about the simulation capabilities of FACET and is based on the Water Drilling Tutorial. If you would like further background to this tutorial we recommend reviewing Water Drilling tutorial first, however, as a brief re-cap:</p>
<p>Drilling a water well is very dangerous and costly. The costs of such drilling are driven by the time it takes to finalize a well in order to start pumping water from it. To reduce those costs, drillers are usually incentivized to drill at a faster pace—measured as the Rate of Penetration (ROP). Depending on soil characteristics, day rates can range from $$$30,000 to $$$250,000. But there is a trade-off: Drilling faster increases the risk of incidents, such as a formation collapse or a gas
infiltration. We will therefore built a machine-learning model to understand the impact of drilling speed on the incident risk, in the context of other risk factors.</p>
<p>For the sake of clarity, we use a simplified dataset for this example. The dataset contains 500 observations, with each row representing a drilling operation of the past, along with a binary indicator of whether or not a well-drilling incident happened in the operation.</p>
<p>Analysis in the Water Drilling tutorial identified a LGBMClassifier with a value of 15 for <code class="docutils literal notranslate"><span class="pre">min_data_in_leaf</span></code> as the best performing model among those investigated, and the final set of relevant features identified were: Weight on bit (kg), Rotation speed (rpm), Depth of operation (m), Mud density (kg/L), Rate of Penetration (ft/h), and Hole diameter (m).</p>
<hr class="docutils" />
<p><strong>Tutorial outline</strong></p>
<ol class="arabic simple">
<li><p><a class="reference external" href="#Required-imports">Required imports</a></p></li>
<li><p><a class="reference external" href="#Data">Data</a></p></li>
<li><p><a class="reference external" href="#Bootstrap-simulation-overview">Bootstrap simulation overview</a></p></li>
<li><p><a class="reference external" href="#Partitioning">Partitioning</a></p></li>
<li><p><a class="reference external" href="#Creating-multiple-train-and-test-splits-with-bootstrap-resampling">Creating multiple train and test splits with bootstrap resampling</a></p></li>
<li><p><a class="reference external" href="#Model-fitting-using-resampled-training-sets">Model fitting using resampled training sets</a></p></li>
<li><p><a class="reference external" href="#Simulating-actuals">Simulating actuals</a></p></li>
<li><p><a class="reference external" href="#Simulating-response">Simulating response</a></p></li>
<li><p><a class="reference external" href="#Summary">Summary</a></p></li>
<li><p><a class="reference external" href="#What-can-you-do-next?">What can you do next?</a></p></li>
</ol>
</div>
<div class="section" id="Required-imports">
<h1>Required imports<a class="headerlink" href="#Required-imports" title="Permalink to this headline">¶</a></h1>
<p>In order to run this notebook, we will import not only the FACET package, but also other packages useful to solve this task. Overall, we can break down the imports into three categories:</p>
<ol class="arabic simple">
<li><p>Common packages (pandas, matplotlib, etc.)</p></li>
<li><p>Required FACET classes (inspection, selection, validation, simulation, etc.)</p></li>
<li><p>Other BCG Gamma packages which simplify pipelining (sklearndf, see on <a class="reference external" href="https://github.com/BCG-Gamma/sklearndf/">GitHub</a>) and support visualization (pytools, see on <a class="reference external" href="https://github.com/BCG-Gamma/pytools">GitHub</a>) when using FACET</p></li>
</ol>
<p><strong>Common package imports</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># list your usual imports here such as pandas, numpy and others</span>
<span class="c1"># not covered by facet, sklearndf or pytools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
<p><strong>FACET imports</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">facet.data</span> <span class="kn">import</span> <span class="n">Sample</span>
<span class="kn">from</span> <span class="nn">facet.validation</span> <span class="kn">import</span> <span class="n">BootstrapCV</span>
<span class="kn">from</span> <span class="nn">facet.simulation.partition</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ContinuousRangePartitioner</span><span class="p">,</span>
    <span class="n">IntegerRangePartitioner</span><span class="p">,</span>
    <span class="n">CategoryPartitioner</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">facet.simulation</span> <span class="kn">import</span> <span class="n">UnivariateProbabilitySimulator</span>
<span class="kn">from</span> <span class="nn">facet.simulation.viz</span> <span class="kn">import</span> <span class="n">SimulationDrawer</span>
<span class="kn">from</span> <span class="nn">facet.crossfit</span> <span class="kn">import</span> <span class="n">LearnerCrossfit</span>
</pre></div>
</div>
</div>
<p><strong>sklearndf imports</strong></p>
<p>Instead of using the “regular” scikit-learn package, we are going to use sklearndf (see on <a class="reference external" href="https://github.com/orgs/BCG-Gamma/sklearndf/">GitHub</a>). sklearndf is an open source library designed to address a common issue with scikit-learn: the outputs of transformers are numpy arrays, even when the input is a data frame. However, to inspect a model it is essential to keep track of the feature names. sklearndf retains all the functionality available through scikit-learn plus the feature
traceability and usability associated with Pandas data frames. Additionally, the names of all your favourite scikit-learn functions are the same except for <code class="docutils literal notranslate"><span class="pre">DF</span></code> on the end. For example, the standard scikit-learn import:</p>
<p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">sklearn.pipeline</span> <span class="pre">import</span> <span class="pre">Pipeline</span></code></p>
<p>becomes:</p>
<p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">sklearndf.pipeline</span> <span class="pre">import</span> <span class="pre">PipelineDF</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sklearndf.pipeline</span> <span class="kn">import</span> <span class="n">ClassifierPipelineDF</span>
<span class="kn">from</span> <span class="nn">sklearndf.classification.extra</span> <span class="kn">import</span> <span class="n">LGBMClassifierDF</span>
</pre></div>
</div>
</div>
<p><strong>pytools imports</strong></p>
<p>pytools (see on <a class="reference external" href="https://github.com/BCG-Gamma/pytools">GitHub</a>) is an open source library containing general machine learning and visualization utilities, some of which are useful for visualising the advanced model inspection capabilities of FACET.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pytools.viz.distribution</span> <span class="kn">import</span> <span class="n">ECDFDrawer</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Data">
<h1>Data<a class="headerlink" href="#Data" title="Permalink to this headline">¶</a></h1>
<p>Based on the water well drilling tutorial, we select a feature set all most linearly independent with the Rate of Penetration (ROP).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># load the prepared dataframe</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;sphinx/source/tutorial/water_drill_data_classification.csv&quot;</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># relevant features identified in previous tutorial</span>
<span class="n">feature_set</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Weight on bit (kg)&#39;</span><span class="p">,</span> <span class="s1">&#39;Rotation speed (rpm)&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Depth of operation (m)&#39;</span><span class="p">,</span> <span class="s1">&#39;Mud density (kg/L)&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Rate of Penetration (ft/h)&#39;</span><span class="p">,</span> <span class="s1">&#39;Hole diameter (m)&#39;</span><span class="p">]</span>

<span class="c1"># create a facet sample object</span>
<span class="n">drilling_obs</span> <span class="o">=</span> <span class="n">Sample</span><span class="p">(</span><span class="n">observations</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                      <span class="n">target_name</span><span class="o">=</span><span class="s2">&quot;Incident&quot;</span><span class="p">,</span>
                      <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_set</span><span class="p">)</span>

<span class="c1"># quick look</span>
<span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>feature</th>
      <th>Weight on bit (kg)</th>
      <th>Rotation speed (rpm)</th>
      <th>Depth of operation (m)</th>
      <th>Mud density (kg/L)</th>
      <th>Rate of Penetration (ft/h)</th>
      <th>Hole diameter (m)</th>
    </tr>
    <tr>
      <th>observation</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>306.141821</td>
      <td>9849.952938</td>
      <td>927.968837</td>
      <td>2.902467</td>
      <td>10.000000</td>
      <td>6.373932</td>
    </tr>
    <tr>
      <th>1</th>
      <td>324.039405</td>
      <td>10744.516916</td>
      <td>1106.187754</td>
      <td>2.106770</td>
      <td>32.898796</td>
      <td>7.507640</td>
    </tr>
    <tr>
      <th>2</th>
      <td>345.377055</td>
      <td>5393.241061</td>
      <td>898.168085</td>
      <td>3.909455</td>
      <td>22.723761</td>
      <td>6.180673</td>
    </tr>
    <tr>
      <th>3</th>
      <td>356.709497</td>
      <td>6776.865696</td>
      <td>769.165223</td>
      <td>2.473607</td>
      <td>25.168914</td>
      <td>5.368265</td>
    </tr>
    <tr>
      <th>4</th>
      <td>328.437275</td>
      <td>6024.116387</td>
      <td>215.202605</td>
      <td>3.033681</td>
      <td>18.921436</td>
      <td>2.092908</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="Bootstrap-simulation-overview">
<h1>Bootstrap simulation overview<a class="headerlink" href="#Bootstrap-simulation-overview" title="Permalink to this headline">¶</a></h1>
<p>The figure above provides and overview of the simulation process for a single bootstrap split. This process is repeated many time to create a distribution of predicted impact for each value of a feature.</p>
<p><img alt="edd3cc8ab1b9407aa60e6d4adb5327df" class="no-scaled-link" src="../_images/Facet-Simulator-BlockDiagram.png" style="width: 750px;" /></p>
<div class="section" id="Partitioning">
<h2>Partitioning<a class="headerlink" href="#Partitioning" title="Permalink to this headline">¶</a></h2>
<p>The first step to simulate feature effects on the target is to set the scope of the study for the feature we want to simulate. Let’s take the ROP measured in feet per hour (ft/h) as the feature to simulate.</p>
<p>The plot below shows that the ROP is centered around 24 ft/h with a range of 10 to 40ft/h.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">SIM_FEATURE</span> <span class="o">=</span> <span class="s2">&quot;Rate of Penetration (ft/h)&quot;</span>
<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">SIM_FEATURE</span><span class="p">],</span> <span class="n">rug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.axes._subplots.AxesSubplot at 0x26ebda4bb08&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Model_simulation_deep_dive_18_1.png" src="../_images/tutorial_Model_simulation_deep_dive_18_1.png" />
</div>
</div>
<p>As ROP is a continuous variable we use the <code class="docutils literal notranslate"><span class="pre">ContinuousRangePartitioner()</span></code> to generate partitions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># instantiate the partitioner</span>
<span class="n">rop_bins</span> <span class="o">=</span> <span class="n">ContinuousRangePartitioner</span><span class="p">()</span>

<span class="c1"># fit the partitioner on the observations&#39; distribution</span>
<span class="n">rop_bins</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">SIM_FEATURE</span><span class="p">])</span>

<span class="c1"># check bins are fit</span>
<span class="n">rop_bins</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<p>Now let’s visualize what the partitioner provides. In the plot below each bar is a partition created by the <code class="docutils literal notranslate"><span class="pre">ContinuousRangePartitioner()</span></code>. <code class="docutils literal notranslate"><span class="pre">rop_bins.partitions_</span></code> provided the bin mid-points, <code class="docutils literal notranslate"><span class="pre">rop_bins.frequencies_</span></code> provided the count of observations for each partition, and <code class="docutils literal notranslate"><span class="pre">rop_bins.partition_width_</span></code> specified the width of our partitions.</p>
<p>The default behaviour of the <code class="docutils literal notranslate"><span class="pre">ContinuousRangePartitioner()</span></code> and <code class="docutils literal notranslate"><span class="pre">IntegerRangePartitioner()</span></code> is to exclude the tail values (2.5th and 97.5th percentiles) of the feature. So, the total number of observations binned is &lt; <em>n</em> (the number of observations). In this case, the partitions encompass 478 of 500 observations (95.6%). The default upper and lower bounds can be changed using the <code class="docutils literal notranslate"><span class="pre">upper_bound</span></code> and <code class="docutils literal notranslate"><span class="pre">lower_bound</span></code> arguments of the <code class="docutils literal notranslate"><span class="pre">ContinuousRangePartitioner()</span></code> and
<code class="docutils literal notranslate"><span class="pre">IntegerRangePartitioner()</span></code>, e.g.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rop_bins</span> <span class="o">=</span> <span class="n">ContinuousRangePartitioner</span><span class="p">(</span><span class="n">lower_bound</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">upper_bound</span><span class="o">=</span><span class="mf">40.</span><span class="p">)</span>
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rop_bins</span><span class="o">.</span><span class="n">partitions_</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">rop_bins</span><span class="o">.</span><span class="n">frequencies_</span><span class="o">/</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">width</span><span class="o">=</span><span class="n">rop_bins</span><span class="o">.</span><span class="n">partition_width_</span><span class="p">,</span>
        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">SIM_FEATURE</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.axes._subplots.AxesSubplot at 0x26ebd791648&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Model_simulation_deep_dive_22_1.png" src="../_images/tutorial_Model_simulation_deep_dive_22_1.png" />
</div>
</div>
<p>If you want to know the bounds for each partition you can use <code class="docutils literal notranslate"><span class="pre">rop_bins.partition_bounds_</span></code>. A quick way to list the midpoint and bounds for each partition is as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rop_bins</span><span class="o">.</span><span class="n">partitions_</span><span class="p">,</span> <span class="n">rop_bins</span><span class="o">.</span><span class="n">partition_bounds_</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(15.0, (14.5, 15.5)),
 (16.0, (15.5, 16.5)),
 (17.0, (16.5, 17.5)),
 (18.0, (17.5, 18.5)),
 (19.0, (18.5, 19.5)),
 (20.0, (19.5, 20.5)),
 (21.0, (20.5, 21.5)),
 (22.0, (21.5, 22.5)),
 (23.0, (22.5, 23.5)),
 (24.0, (23.5, 24.5)),
 (25.0, (24.5, 25.5)),
 (26.0, (25.5, 26.5)),
 (27.0, (26.5, 27.5)),
 (28.0, (27.5, 28.5)),
 (29.0, (28.5, 29.5)),
 (30.0, (29.5, 30.5)),
 (31.0, (30.5, 31.5)),
 (32.0, (31.5, 32.5)),
 (33.0, (32.5, 33.5))]
</pre></div></div>
</div>
<p>The above example utilized the <code class="docutils literal notranslate"><span class="pre">ContinuousRangePartitioner()</span></code>. FACET has three variations of partitioner available depending on the feature type, <code class="docutils literal notranslate"><span class="pre">ContinuousRangePartitioner()</span></code>, <code class="docutils literal notranslate"><span class="pre">IntegerRangePartitioner()</span></code> and <code class="docutils literal notranslate"><span class="pre">CategoryPartitioner()</span></code>. In summary:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">CategoryPartitioner()</span></code> will create a partition for each unique value of the feature. If the number of partitions &lt; number of unique values in the category, the top n partition frequent categories will be used.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">IntegerRangePartitioner()</span></code> will subdivide the feature range of values into almost equal-sized partitions while ensuring the partition bounds are integers. Each partition is represented by an integer value. If your integer feature is positive or strictly positive or has an upper bound, be sure to use the <code class="docutils literal notranslate"><span class="pre">lower_bound</span></code> and/or <code class="docutils literal notranslate"><span class="pre">upper_bound</span></code> arguments.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ContinuousRangePartitioner()</span></code> will subdivide the feature range of values into equal-sized partitions. Each partition is represented by the partition mid-point.</p></li>
</ul>
</div>
<div class="section" id="Creating-multiple-train-and-test-splits-with-bootstrap-resampling">
<h2>Creating multiple train and test splits with bootstrap resampling<a class="headerlink" href="#Creating-multiple-train-and-test-splits-with-bootstrap-resampling" title="Permalink to this headline">¶</a></h2>
<p>Bootstrapping is the process of resampling data with replacement to generate a data set of the same size as the original. Bootstrapping lends itself naturally to use as a cross-validation mechanism as we get a training dataset of the same size as the original data representing a theoretical draw from the same population as the original data, and a hold-out test set of unique observations also from a similar population as the original dataset and with a reasonable size (~37%).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># instantiate bootstrap cross validation iterator with 1000 splits</span>
<span class="n">boot_cv</span> <span class="o">=</span> <span class="n">BootstrapCV</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># extract the sample index for the first test-train split</span>
<span class="p">(</span><span class="n">train_split_1</span><span class="p">,</span> <span class="n">test_split_1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">boot_cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>

<span class="c1"># calculate charateristics of indexes for first split</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original dataset n = </span><span class="si">{</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resampled training set n = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_split_1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resampled training set number of unique values = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_split_1</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test set n = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_split_1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap between index for train and test = </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">train_split_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_split_1</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Original dataset n = 500
Resampled training set n = 500
Resampled training set number of unique values = 300
Test set n = 200
Overlap between index for train and test = []
</pre></div></div>
</div>
<p>As we can see, in the first split we have a training set of 500 observations (the same size as the original dataset) that contains 300 unique observations sampled from the original dataset. The remaining 200 observations the were not sampled are put aside as the test split. This represents a single bootstrap split. Further, because the training set for each bootstrap is those observations that were not sampled, this number can vary from split to split, while the size of the training set is
constant.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># extract index lengths for each bootstrap test train split</span>
<span class="n">rows</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">len</span><span class="p">(</span><span class="n">train_index</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_index</span><span class="p">)]</span> <span class="k">for</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span> <span class="ow">in</span> <span class="n">boot_cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">target</span><span class="p">)]</span>
<span class="n">num_obs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;n_train&#39;</span><span class="p">,</span> <span class="s1">&#39;n_test&#39;</span><span class="p">])</span>
<span class="n">num_obs_df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_train</th>
      <th>n_test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>1000.0</td>
      <td>1000.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>500.0</td>
      <td>184.029000</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.0</td>
      <td>6.771263</td>
    </tr>
    <tr>
      <th>min</th>
      <td>500.0</td>
      <td>162.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>500.0</td>
      <td>179.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>500.0</td>
      <td>184.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>500.0</td>
      <td>189.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>500.0</td>
      <td>205.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Hence, in this example we can see that we have generated 1000 training datasets of 500 observations, while the size of the training set varies between 162 and 205, with a median size of 184 (36.8%) which is a little over one third of the data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># compare ECDF for test and train first split with original</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ECDFDrawer</span><span class="p">()</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">SIM_FEATURE</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Original data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ECDFDrawer</span><span class="p">()</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_split_1</span><span class="p">,</span> <span class="p">[</span><span class="n">SIM_FEATURE</span><span class="p">]],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Training data - split 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ECDFDrawer</span><span class="p">()</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_split_1</span><span class="p">,</span> <span class="p">[</span><span class="n">SIM_FEATURE</span><span class="p">]],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Test data - split 1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Model_simulation_deep_dive_31_0.png" src="../_images/tutorial_Model_simulation_deep_dive_31_0.png" />
</div>
</div>
<p>We can also see that bootstrap resampling with sufficient sample size provides feature distributions in the train and test sets that are representative of the original data.</p>
</div>
<div class="section" id="Model-fitting-using-resampled-training-sets">
<h2>Model fitting using resampled training sets<a class="headerlink" href="#Model-fitting-using-resampled-training-sets" title="Permalink to this headline">¶</a></h2>
<p>With our resampled training sets the idea is to use the model we identified previously and fit the model on each one in order to generate a series of models that will give slightly different predictions for the same feature combination.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># best perfoming light gradient boosting learner identified previously</span>
<span class="n">lgbm_clf</span> <span class="o">=</span> <span class="n">ClassifierPipelineDF</span><span class="p">(</span>
    <span class="n">classifier</span><span class="o">=</span><span class="n">LGBMClassifierDF</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">min_data_in_leaf</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># instantiate the crossfit</span>
<span class="n">boot_crossfit</span> <span class="o">=</span> <span class="n">LearnerCrossfit</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="o">=</span><span class="n">lgbm_clf</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">boot_cv</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># fit the model</span>
<span class="n">boot_crossfit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="n">drilling_obs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
[Parallel(n_jobs=-3)]: Using backend LokyBackend with 6 concurrent workers.
[Parallel(n_jobs=-3)]: Done  38 tasks      | elapsed:   16.9s
[Parallel(n_jobs=-3)]: Done 188 tasks      | elapsed:   25.2s
[Parallel(n_jobs=-3)]: Done 438 tasks      | elapsed:   39.6s
[Parallel(n_jobs=-3)]: Done 788 tasks      | elapsed:  1.0min
[Parallel(n_jobs=-3)]: Done 1000 out of 1000 | elapsed:  1.2min finished
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;facet.crossfit._crossfit.LearnerCrossfit at 0x26ebdbc1608&gt;
</pre></div></div>
</div>
<p>After fitting the crossfit, <code class="docutils literal notranslate"><span class="pre">boot_crossfit.models()</span></code> contains the model fitted on each resampled training set. We can check this as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model_split_1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">boot_crossfit</span><span class="o">.</span><span class="n">models</span><span class="p">())</span>
<span class="n">model_split_1</span><span class="o">.</span><span class="n">is_fitted</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<p>We can also get a sense of the variation in prediction for a single feature combination across the different splits and hence, trained models.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">single_test_obs</span> <span class="o">=</span> <span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">single_test_obs</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">boot_crossfit</span><span class="o">.</span><span class="n">models</span><span class="p">()]</span>
<span class="n">pred_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pred_prob&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pred_df</span><span class="p">[</span><span class="s1">&#39;pred_prob&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
count    1000.000000
mean        0.031569
std         0.085192
min         0.000408
25%         0.002812
50%         0.005577
75%         0.015844
max         0.936496
Name: pred_prob, dtype: float64
</pre></div></div>
</div>
<p>In this case for the observation we choose, we see that the 1000 models produce an average predicted probability of the positive class of 0.03 with an IQR of 0.003 to 0.015.</p>
</div>
<div class="section" id="Simulating-actuals">
<h2>Simulating actuals<a class="headerlink" href="#Simulating-actuals" title="Permalink to this headline">¶</a></h2>
<p>For each test split we can predict the outcome and look at the deviation between the average prediction for a test split and the actual average of the target in the original dataset. The spread and offset of these deviations can serve as an indication of how the bias of the model contributes to the uncertainty of simulations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># instantiate simulator</span>
<span class="n">rop_simulator</span> <span class="o">=</span> <span class="n">UnivariateProbabilitySimulator</span><span class="p">(</span><span class="n">crossfit</span><span class="o">=</span><span class="n">boot_crossfit</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># simulate average difference between</span>
<span class="n">actual_distribution</span> <span class="o">=</span> <span class="n">rop_simulator</span><span class="o">.</span><span class="n">simulate_actuals</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">actual_distribution</span><span class="p">,</span> <span class="n">rug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.axes._subplots.AxesSubplot at 0x26ebe10a988&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Model_simulation_deep_dive_43_1.png" src="../_images/tutorial_Model_simulation_deep_dive_43_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Median: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">actual_distribution</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lower bound: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">actual_distribution</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;upper bound: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">actual_distribution</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Median: 0.01144604449983927
lower bound: -0.041598812224331705
upper bound: 0.06341163035165856
</pre></div></div>
</div>
<p>In our case, the model’s deviation does not exceed 6% of the target.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># the actual for the first split</span>
<span class="n">actual_distribution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
-0.026460215618179683
</pre></div></div>
</div>
<p>Now to convince ourselves that this indeed works, lets grab the fitted model and the test set for the first split in our cross fit and see if we can re-produce the number for the first split.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model_split_1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">boot_crossfit</span><span class="o">.</span><span class="n">models</span><span class="p">())</span>
<span class="p">(</span><span class="n">train_split_1</span><span class="p">,</span> <span class="n">test_split_1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">boot_crossfit</span><span class="o">.</span><span class="n">splits</span><span class="p">())</span>
<span class="n">yhat_split_1</span> <span class="o">=</span> <span class="n">model_split_1</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_split_1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">yhat_split_1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">drilling_obs</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
-0.026460215618179683
</pre></div></div>
</div>
</div>
<div class="section" id="Simulating-response">
<h2>Simulating response<a class="headerlink" href="#Simulating-response" title="Permalink to this headline">¶</a></h2>
<p>With the 1000 bootstrap splits in place and our preferred model trained on each each resampled training split, the last step is to perform prediction for the partitions of the selected feature. For each test set the selected feature is set equal to the value for a partition and the outcome predicted using the trained model for that split. The average value of the outcome is then calculated. This is repeated for each partition and in our example we have 19 partitions, so one bootstrap split will
yield 19 values (one for each split). This is repeated for every bootstrap split, so with a 1000 splits, we end up with 1000 by 19 average predicted values. This means for each partition we have a distribution of a 1000 values from which we can summarize to describe the likely outcome (and associated variability) for a specific value of our feature.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># first run the simulator</span>
<span class="n">rop_simulation</span> <span class="o">=</span> <span class="n">rop_simulator</span><span class="o">.</span><span class="n">simulate_feature</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="n">SIM_FEATURE</span><span class="p">,</span> <span class="n">partitioner</span><span class="o">=</span><span class="n">rop_bins</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># now draw the output</span>
<span class="n">SimulationDrawer</span><span class="p">()</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">rop_simulation</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">SIM_FEATURE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Model_simulation_deep_dive_51_0.png" src="../_images/tutorial_Model_simulation_deep_dive_51_0.png" />
</div>
</div>
<p>For each partition bin (grey bar under the x-axis) thanks to bootstrapping we have a distribution of 1000 values for each, and we can access these values as shown below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rop_simulation</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>partition</th>
      <th>15.0</th>
      <th>16.0</th>
      <th>17.0</th>
      <th>18.0</th>
      <th>19.0</th>
      <th>20.0</th>
      <th>21.0</th>
      <th>22.0</th>
      <th>23.0</th>
      <th>24.0</th>
      <th>25.0</th>
      <th>26.0</th>
      <th>27.0</th>
      <th>28.0</th>
      <th>29.0</th>
      <th>30.0</th>
      <th>31.0</th>
      <th>32.0</th>
      <th>33.0</th>
    </tr>
    <tr>
      <th>split</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.101664</td>
      <td>0.102129</td>
      <td>0.102129</td>
      <td>0.127051</td>
      <td>0.289950</td>
      <td>0.318046</td>
      <td>0.376368</td>
      <td>0.391437</td>
      <td>0.414414</td>
      <td>0.642005</td>
      <td>0.712186</td>
      <td>0.759170</td>
      <td>0.788929</td>
      <td>0.790189</td>
      <td>0.790853</td>
      <td>0.759104</td>
      <td>0.800065</td>
      <td>0.869275</td>
      <td>0.860593</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.101009</td>
      <td>0.101009</td>
      <td>0.101009</td>
      <td>0.120365</td>
      <td>0.330684</td>
      <td>0.388922</td>
      <td>0.404168</td>
      <td>0.410661</td>
      <td>0.452702</td>
      <td>0.638327</td>
      <td>0.757588</td>
      <td>0.738819</td>
      <td>0.736709</td>
      <td>0.798288</td>
      <td>0.821636</td>
      <td>0.781306</td>
      <td>0.815064</td>
      <td>0.851109</td>
      <td>0.851109</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.110277</td>
      <td>0.123668</td>
      <td>0.123668</td>
      <td>0.223646</td>
      <td>0.286837</td>
      <td>0.302374</td>
      <td>0.324577</td>
      <td>0.371927</td>
      <td>0.470678</td>
      <td>0.554602</td>
      <td>0.748958</td>
      <td>0.771619</td>
      <td>0.811980</td>
      <td>0.809153</td>
      <td>0.801599</td>
      <td>0.790892</td>
      <td>0.797951</td>
      <td>0.797951</td>
      <td>0.834546</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.061717</td>
      <td>0.168085</td>
      <td>0.176332</td>
      <td>0.230813</td>
      <td>0.315849</td>
      <td>0.388079</td>
      <td>0.426965</td>
      <td>0.459117</td>
      <td>0.471895</td>
      <td>0.588239</td>
      <td>0.671992</td>
      <td>0.695215</td>
      <td>0.763153</td>
      <td>0.774555</td>
      <td>0.794486</td>
      <td>0.759805</td>
      <td>0.759280</td>
      <td>0.773171</td>
      <td>0.859550</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.152520</td>
      <td>0.152520</td>
      <td>0.152520</td>
      <td>0.168394</td>
      <td>0.192480</td>
      <td>0.350494</td>
      <td>0.426593</td>
      <td>0.472164</td>
      <td>0.549988</td>
      <td>0.570377</td>
      <td>0.721708</td>
      <td>0.774074</td>
      <td>0.818288</td>
      <td>0.817001</td>
      <td>0.807597</td>
      <td>0.784455</td>
      <td>0.776444</td>
      <td>0.921845</td>
      <td>0.913441</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Taking the bin centered at 23.0 as an example we can plot the distribution of the probability of the outcome as follows and show the median, 2.5th and 97.5th percentiles which are the values shown for this partition in the plot above.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">rop_simulation</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mf">23.0</span><span class="p">],</span> <span class="n">rug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.axes._subplots.AxesSubplot at 0x26ece9bd888&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Model_simulation_deep_dive_55_1.png" src="../_images/tutorial_Model_simulation_deep_dive_55_1.png" />
</div>
</div>
<p>For this partition we could also see that for the first split the average predicted probability of the outcome was 0.41.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rop_simulation</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">23.0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.41441401031476105
</pre></div></div>
</div>
<p>To confirm our understanding of how the number was generated, we can take the test data and model from the first split generated as part of the bootstrap-crossfit and calculate it.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model_split_1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">boot_crossfit</span><span class="o">.</span><span class="n">models</span><span class="p">())</span>
<span class="p">(</span><span class="n">train_split_1</span><span class="p">,</span> <span class="n">test_split_1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">boot_crossfit</span><span class="o">.</span><span class="n">splits</span><span class="p">())</span>
<span class="n">test_split_1_modified</span> <span class="o">=</span> <span class="n">drilling_obs</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_split_1</span><span class="p">]</span>
<span class="n">test_split_1_modified</span><span class="p">[</span><span class="n">SIM_FEATURE</span><span class="p">]</span> <span class="o">=</span> <span class="mf">23.0</span>
<span class="n">model_split_1</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">test_split_1_modified</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.41441401031476105
</pre></div></div>
</div>
<p>As expected this single value among the 1000 generated for this partition is the average predicted probability of the outcome in the first bootstrap test set using the selected model trained on the first bootstrap resample.</p>
</div>
</div>
<div class="section" id="Summary">
<h1>Summary<a class="headerlink" href="#Summary" title="Permalink to this headline">¶</a></h1>
<p><strong>Partitioning</strong></p>
<ol class="arabic simple">
<li><p>Select the right partitioner for your type of feature: categorical, integer or continuous.</p></li>
<li><p>Note that feature partitions are derived from the full dataset and the tail values of the observations will be excluded for integer and float type features (unles.</p></li>
</ol>
<p><strong>Creating multiple train and test splits with bootstrap resampling</strong></p>
<ol class="arabic simple" start="3">
<li><p>The bootstrap resampling produces <em>m</em> training sets of size <em>n</em> and <em>m</em> test sets on average of size 0.368<em>n</em>. On average a training set will contain 0.632<em>n</em> unique observations from the original data.</p></li>
<li><p>The resampling creates train and test sets the are representative of the original data.</p></li>
</ol>
<p><strong>Model fitting using resampled training sets</strong></p>
<ol class="arabic simple" start="5">
<li><p>The selected model is fit on each training set and so each split will generate a slightly different prediction for the same feature combination.</p></li>
</ol>
<p><strong>Simulating actuals</strong></p>
<ol class="arabic simple" start="6">
<li><p>The spread and offset of the deviations between the average predicted value for the test set and the average of the target in the original dataset can serve as an indication of how the bias of the model may contribute to uncertainty in simulation.</p></li>
</ol>
<p><strong>Simulating response</strong></p>
<ol class="arabic simple" start="7">
<li><p>The bootstrap average predictions for each partition yields a distribution of expected values for the target for that partition.</p></li>
</ol>
</div>
<div class="section" id="What-can-you-do-next?">
<h1>What can you do next?<a class="headerlink" href="#What-can-you-do-next?" title="Permalink to this headline">¶</a></h1>
<ol class="arabic simple">
<li><p>Try out using a different feature for simulation</p></li>
<li><p>Create a different feature type and try using a different partitioner</p></li>
<li><p>Create a model for a dataset with a continuous target and try out the <code class="docutils literal notranslate"><span class="pre">UnivariateTargetSimulator</span></code>and the <code class="docutils literal notranslate"><span class="pre">UnivariateUpliftSimulator</span></code>.</p></li>
</ol>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="Classification_with_Facet.html" title="previous page">Classification with FACET: Prediabetes Study</a>
    <a class='right-next' id="next-link" href="Synergy_Redundancy_Tutorial_with_Facet.html" title="next page">Intuition on synergy &amp; redundancy</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2020, Boston Consulting Group (BCG).<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>